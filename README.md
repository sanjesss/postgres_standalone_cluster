Инсталляция одиночного кластер PostgreSQL и обвязки для него.
=========

Этот плейбук нужен для подготовки машины и установки одиночного кластера PostgreSQL. Также эта роль способна установить и сконфигурировать пулер соединей Odyssey, агент доставки логов Filebeat, агент postgres_exporter для prometheus, систему резервного копирования pg_probackup, агент мониторинга хоста Telegraf.

Подготовка.
------------

Для корректной работы роли необходимо:
1. Сервер с RedHat-based дистрибутивом для установки кластера.
2. Созданная отдельная ФС в корне диска с названием /data.
3. Пользователь с sudo правами.
4. Загрузить необходимые файлы в соответствующую директорию.
5. Прописать переменные.

Из ПО используются:
1. Ванильный ansible>=2.9.25 установленный на wsl.
2. Пакеты PostgreSQL: server, lib, contrib, client.
3. Пакет Telegraf.
4. Архив с готовым бинарником postgres_exporter.
5. Пакеты pg_probackup: debug и "client".
6. Odyssey бинарный файл.
7. Пакет filebeat.
8. Скрипт DB helper.

Перед запуском плейбука необходимо отредактировать файл pg_single_install/defaults/main.yml и установить параметры, с которыми будет устанавливаться ПО. Можно провести установку с параметрами по умолчанию, нужно будет указать только адреса RPM пакетов и мажорную версию PostgreSQL.  
  
По умолчанию происходит подготовка системы, установка, конфигурирование и запус экземпляра PostgreSQL, установка и конфигурирование агента Telegraf, postgres_exporter, pg_probackup, Odyssey, Filebeat без последующей перезагрузки хоста.  
В секции "Параметры PostgreSQL" необходимо установить такие параметры как: целевая версия, названия пакетов, параметры для postgresql.conf. По умолчанию кластер устанавливается с стандартными настройками для 13 версии, кроме: archive_command, archive_mode, archive_timeout, full_page_writers, listen_adresses, logging_collector, log_directory, log_filname, log_rotation_age, log_line_prefix.  
В секции "Параметры Telegraf" необходимо установить такие параметры как: название пакета, наличие контейнеризации на хосте и тип сервера для InfluxDB.  
В секции "Параметры postgres_exporter" необходимо установить название архива с postgres_exporter.  
В секции "Параметры pg_probackup" необходимо установить название пакетов с pg_probackup. По умолчанию полные бекапы делаются в 02:00 по МСК, в ПН и ЧТ, инкрементальные бекапы в то же время в ВС, ВТ, СР, ПТ, СБ. Уровень компрессии - максимальный, средствами zlib.  
В секции "Параметры Odyssey" парметры по умолчанию установят пулер на порту 6432.  
В секции "Параметры Filebeat" необходимо указать название пакета.  
  
Более полное и подробное описание почти всех переменных находится в файле pg_single_install/defaults/main.yml.
Пакеты, которые будут использоваться в ходе установки роль тянет с общебанковского репозитория.
  
После отработки плейбука останется установить пароль linux пользователю postgres, прописать необходимые разрешения в pg_hba.conf.
  
Краткое описание действий роли:
------------

1. Подготавливает машину: отключает SELinux, открывает необходимые порты.
2. Устанавливает, конфигурирует и запускает кластер PostgreSQL.
3. Создаёт необходимые директории, устанавливает права.
4. Устанавливает, конфигурирует и запускает Telegraf.
5. Устанавливает, конфигурирует и запускает postgres_exporter.
6. Устанавливает, конфигурирует и запускает pg_probackup.
7. Устанавливает, конфигурирует и запускает Odyssey. 
8. Устанавливает, конфигурирует и запускает Filebeat
9. Перезагружает машину, если необходимо.
10. Добавляет скрипт DB helper.

Есть возможность создания мастера и реплики:
------------

Для создания мастера или реплики необходимо прописать yes параметрам INSTALL_PG_AS_MASTER или INSTALL_PG_AS_REPLICA. После этого будет создан, автоматически сконфигрурирован и запущен мастер или слейв кластер. 

Полезные ссылки:
------------

Что может понадобится:

Сторонние репозитории:
1. [Ванильный PostgreSQL](https://download.postgresql.org/pub/repos/yum/)
2. [Загрузка Telegraf](https://portal.influxdata.com/downloads/)
3. [Репозиторий postgres_exporter](https://github.com/prometheus-community/postgres_exporter)
4. [Репозиторий pg_probackup](http://repo.postgrespro.ru/pg_probackup/rpm/)
5. [Репозиторий Odyssey](https://github.com/yandex/odyssey)
6. [Загрузка Filebeat](https://www.elastic.co/downloads/beats/filebeat)

Наши репозитории:
1. [Репозиторий архивов](https://binary.alfabank.ru/artifactory/generic-postgresql-materials/)
2. [Репозиторийй пакетов](https://binary.alfabank.ru/artifactory/rpm-postgresql-materials/)
3. [Репозиторий PostgreSQL](http://binary.alfabank.ru/artifactory/postgresql/repos/yum/)

Доработки:
------------

1. Создание подпапок в в /data (Выполнено)
2. Автоматическая подготовка postgresql.conf файла (Выполнено)
3. Доработка плейбука для возможности создания реплики. (Выполнено спасибо Никита Борщевский)
4. Залить все пакеты в наши репо и переписать плейбук для этого. (Выполнено)
5. Установка агента filebeat для сбора логов. (Выполнено)
6. Автоматическая настройка бекапирования. (Выполнено)
7. Автоматическая настройка архивирования. (Выполнено)
8. Конфигурирование всего файла postgresql.conf
9. Настройки ротации логов. (Выполнено)
10. Добавить скрипт DB helper. (Выполнено)
11. Недоработка в записях crontab, некорректно выполнялся скрипт резервного копирования. (Исправлено)
12. Автоматическое использование YUM или DNF в зависимости от системы. (Выполнено)