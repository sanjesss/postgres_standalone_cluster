---  
- name: install Postgres rpm's
  yum:
    name: "{{ item }}"
    state: present
  loop:
    - "{{ PG_LIBS_URL }}"
    - "{{ PG_CLIENT_URL }}"
    - "{{ PG_SERVER_UR }}"
    - "{{ PG_CONTRIB_URL }}"
  when: ansible_pkg_mgr == "yum"

- name: install Postgres rpm's
  dnf:
    name: "{{ item }}"
    state: present
  loop:
    - "{{ PG_LIBS_URL }}"
    - "{{ PG_CLIENT_URL }}"
    - "{{ PG_SERVER_UR }}"
    - "{{ PG_CONTRIB_URL }}"
  when: ansible_pkg_mgr == "dnf"

- name: Create dir for PostgreSQL
  file:
    path: "{{ item }}"
    owner: postgres
    group: postgres
    state: directory
    mode: '0770'
  loop:
    - /data/
    - /data/pgsql/
    - /data/archive/
    - /data/log/

- name: Chown PostgreSQL directory
  file:
    path: "{{ item }}"
    owner: postgres
    group: postgres
    recurse: yes
  loop:
    - /usr/pgsql-{{ PG_VERSION_NUMBER }}
    - /data/

- name: Confrim destroy cluster
  pause:
    prompt: "This command will destroy the cluster if it exists. Are you sure? (yes/no)"
  register: confirm_delete

- name: Delete files old cluster if exist
  file:
    state: absent
    path: /data/pgsql/
  when: confirm_delete.user_input | bool

- name: Copy cluster with help pg_basebackup 
  command: pg_basebackup --pgdata=/data/pgsql/ --format=p --write-recovery-conf --checkpoint=fast --slot={{ PG_REPL_SLOT_NAME }} --host={{ PG_REPL_MASTER_ADDR }} --port={{ PG_PORT }} --username={{ PG_REPL_USERNAME }}
  become: true
  become_user: postgres

- name: Start pg_cluster
  command: /usr/pgsql-{{ PG_VERSION_NUMBER }}/bin/pg_ctl -D /data/pgsql start
  become: true
  become_user: postgres
    
- name: Create pg_control script file
  template:
    src: templates/pg_control.j2
    dest: /var/lib/pgsql/pg_control.sh
    owner: postgres
    group: postgres
    mode: u+rwx,g+rw,o+r

- name: Create environment file for DB Helper
  template:
    src: templates/environment_pg.j2
    dest: /var/lib/pgsql/{{ ansible_hostname }}.env
    owner: postgres
    group: postgres
    mode: u+rwx,g+rw,o+r

- name: Copy DB helper
  copy:
    src: files/dbhelper_pg.sh
    dest: /var/lib/pgsql/dbhelper_pg.sh
    owner: postgres
    group: postgres
    mode: u+rwx,g+rwx,o+r

- name: Adding DB Helper to bash autoload
  lineinfile:
    dest: /var/lib/pgsql/.bash_profile
    line: sh /var/lib/pgsql/dbhelper_pg.sh